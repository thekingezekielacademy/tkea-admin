/**
 * Check if batch class sessions exist in database
 */

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: '.env.production' });

async function checkSessions() {
  const supabaseUrl = process.env.REACT_APP_SUPABASE_URL || process.env.SUPABASE_URL;
  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

  if (!supabaseUrl || !supabaseServiceKey) {
    console.error('‚ùå Missing Supabase configuration!');
    return;
  }

  const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey);
  const now = new Date();
  const futureTime = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

  console.log('üîç Checking batch class system...\n');

  // 1. Check batch_classes
  console.log('1Ô∏è‚É£ Checking batch_classes...');
  const { data: batchClasses, error: bcError } = await supabaseAdmin
    .from('batch_classes')
    .select('*')
    .eq('is_active', true);

  if (bcError) {
    console.error('‚ùå Error:', bcError);
  } else {
    console.log(`‚úÖ Found ${batchClasses?.length || 0} active batch classes`);
    batchClasses?.forEach(bc => {
      console.log(`   - ${bc.class_name} (Day ${bc.start_day_of_week})`);
    });
  }

  // 2. Check batches
  console.log('\n2Ô∏è‚É£ Checking batches...');
  const { data: batches, error: batchesError } = await supabaseAdmin
    .from('batches')
    .select('*')
    .eq('status', 'active')
    .order('start_date', { ascending: false });

  if (batchesError) {
    console.error('‚ùå Error:', batchesError);
  } else {
    console.log(`‚úÖ Found ${batches?.length || 0} active batches`);
    if (batches?.length === 0) {
      console.log('   ‚ö†Ô∏è  NO BATCHES FOUND! Need to create batches.');
      console.log('   üí° Run: Go to /admin/batch-classes-status and click "Kickstart System"');
    } else {
      batches?.forEach(b => {
        console.log(`   - ${b.class_name} Batch ${b.batch_number} (Started: ${b.start_date})`);
      });
    }
  }

  // 3. Check sessions
  console.log('\n3Ô∏è‚É£ Checking sessions...');
  const { data: sessions, error: sessionsError } = await supabaseAdmin
    .from('batch_class_sessions')
    .select('*')
    .in('status', ['scheduled', 'in_progress'])
    .gte('scheduled_datetime', now.toISOString())
    .lte('scheduled_datetime', futureTime.toISOString())
    .order('scheduled_datetime', { ascending: true });

  if (sessionsError) {
    console.error('‚ùå Error:', sessionsError);
  } else {
    console.log(`‚úÖ Found ${sessions?.length || 0} upcoming sessions`);
    if (sessions?.length === 0) {
      console.log('   ‚ö†Ô∏è  NO SESSIONS FOUND! Need to generate sessions.');
      console.log('   üí° Sessions are generated by the cron job at midnight');
      console.log('   üí° Or manually trigger: /api/cron/generate-batch-sessions');
    } else {
      console.log('\n   Upcoming sessions:');
      sessions?.slice(0, 10).forEach(s => {
        const sessionTime = new Date(s.scheduled_datetime);
        console.log(`   - ${s.class_name} Class ${s.session_number} at ${sessionTime.toLocaleString()}`);
      });
      if (sessions.length > 10) {
        console.log(`   ... and ${sessions.length - 10} more`);
      }
    }
  }

  // 4. Summary
  console.log('\nüìä SUMMARY:');
  console.log(`   Batch Classes: ${batchClasses?.length || 0}`);
  console.log(`   Active Batches: ${batches?.length || 0}`);
  console.log(`   Upcoming Sessions: ${sessions?.length || 0}`);

  if (batches?.length === 0) {
    console.log('\n‚ùå PROBLEM: No batches found!');
    console.log('   SOLUTION: Go to /admin/batch-classes-status and click "Kickstart System"');
  } else if (sessions?.length === 0) {
    console.log('\n‚ùå PROBLEM: No sessions found!');
    console.log('   SOLUTION: Sessions need to be generated');
    console.log('   - Wait for cron job at midnight (UTC)');
    console.log('   - Or manually trigger: POST /api/cron/generate-batch-sessions');
  } else {
    console.log('\n‚úÖ Everything looks good! Sessions exist, notifications should work.');
  }
}

checkSessions();
